const SHEET_ID = "17Y3yQ8FRca94TvqMNsSU2eySY7UTV4YObY57K822U6s";
const SHEET_NAME = "à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸‚à¹‰à¸²";
const CASH_SHEET_NAME = "à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸‚à¹‰à¸²à¹€à¸‡à¸´à¸™à¸ªà¸”";
const PARENT_FOLDER_ID = "1wj0KK43xiQgPDKm-wuuDH_kh08iDhqbz";
const SUB_FOLDER_NAME = "Visitor_ID_Photos";

function doPost(e) {
  const params = e.parameter;
  const action = params.action || "";

  if (action === "entry") return handleEntry(params);
  if (action === "cashEntry") return handleCashEntry(params);
  if (action === "nameList") return getNameList();
  if (action === "houseList") return getHouseList();

  return ContentService.createTextOutput("âŒ à¹„à¸¡à¹ˆà¸žà¸š action à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸‡à¸‚à¸­");
}

// âœ… à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸‚à¹‰à¸²à¹à¸šà¸šà¸›à¸à¸•à¸´
function handleEntry(params) {
  return processEntry(params, SHEET_NAME, false);
}

// âœ… à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸‚à¹‰à¸²à¹à¸šà¸š "à¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¸ªà¸”"
function handleCashEntry(params) {
  return processEntry(params, CASH_SHEET_NAME, true);
}

// ðŸ§  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸¥à¸²à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
function processEntry(params, sheetName, isCash) {
  try {
    Logger.log("ðŸ”µ à¹€à¸£à¸´à¹ˆà¸¡ processEntry");

    const name = (params.fullname || "").trim();
    const dept = params.department || "";
    const note = params.note || "";
    const filename = params.filename || "photo.jpg";
    const fileData = params.file;

    Logger.log("ðŸ“¥ à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ: " + JSON.stringify({ name, dept, filename }));

    if (!name || !dept || !fileData) {
      Logger.log("â›” à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸š");
      return ContentService.createTextOutput("ðŸš« à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
    }

    const now = new Date();
    const dateStr = Utilities.formatDate(now, "Asia/Bangkok", "yyyy-MM-dd");
    const timeStr = Utilities.formatDate(now, "Asia/Bangkok", "HH:mm:ss");
    const shift = (now.getHours() >= 6 && now.getHours() < 17) ? "D" : "N";

    Logger.log("â° à¸§à¸±à¸™à¹€à¸§à¸¥à¸²: " + dateStr + " " + timeStr + " shift=" + shift);

    const blob = Utilities.newBlob(Utilities.base64Decode(fileData), MimeType.JPEG, filename);
    Logger.log("ðŸ§± à¸ªà¸£à¹‰à¸²à¸‡ blob à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");

    const folder = getOrCreateSubFolder(PARENT_FOLDER_ID, SUB_FOLDER_NAME);
    Logger.log("ðŸ“ à¹„à¸”à¹‰à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ: " + folder.getName());

    const safeName = name.replace(/[^\u0E00-\u0E7Fa-zA-Z0-9]/g, "_");
    const fullFileName = `${safeName}_${isCash ? "CASH_" : ""}${dateStr.replace(/-/g, "")}_${timeStr.replace(/:/g, "")}.jpg`;
    blob.setName(fullFileName);
    Logger.log("ðŸ“Ž à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­ blob à¹€à¸›à¹‡à¸™: " + fullFileName);

    const file = folder.createFile(blob);
    Logger.log("ðŸ“¤ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸ªà¸³à¹€à¸£à¹‡à¸ˆ URL: " + file.getUrl());

    const row = [name, dept, dateStr, timeStr, shift, file.getUrl(), note];
    if (isCash) row.push("");
    Logger.log("ðŸ“„ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸–à¸§à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸žà¸´à¹ˆà¸¡: " + JSON.stringify(row));

    const sheet = getSheet(sheetName);
    if (!sheet) throw new Error("à¹„à¸¡à¹ˆà¸žà¸šà¸Šà¸µà¸•: " + sheetName);
    Logger.log("ðŸ“‘ à¸žà¸šà¸Šà¸µà¸•: " + sheet.getName());

    sheet.appendRow(["", ...row]);
    Logger.log("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡à¸Šà¸µà¸•à¹à¸¥à¹‰à¸§");

    return ContentService.createTextOutput(`âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ${isCash ? " (à¹€à¸‡à¸´à¸™à¸ªà¸”)" : ""}`);
  } catch (err) {
    Logger.log("âŒ ERROR: " + err.message);
    return ContentService.createTextOutput("âŒ ERROR: " + err.message);
  }
}

// ðŸ“‹ à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸žà¸™à¸±à¸à¸‡à¸²à¸™
function getNameList() {
  const sheet = getSheet("à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸žà¸™à¸±à¸à¸‡à¸²à¸™");
  const values = sheet.getRange("A2:A").getValues();
  return ContentService.createTextOutput(JSON.stringify(values.flat().filter(v => v)))
    .setMimeType(ContentService.MimeType.JSON);
}

// ðŸ“‹ à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™
function getHouseList() {
  const sheet = getSheet("à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™");
  const values = sheet.getRange("A2:A").getValues();
  return ContentService.createTextOutput(JSON.stringify(values.flat().filter(v => v)))
    .setMimeType(ContentService.MimeType.JSON);
}

// ðŸ“„ Utility
function getSheet(name) {
  return SpreadsheetApp.openById(SHEET_ID).getSheetByName(name);
}

function getOrCreateSubFolder(parentFolderId, subFolderName) {
  const parent = DriveApp.getFolderById(parentFolderId);
  const folders = parent.getFoldersByName(subFolderName);
  return folders.hasNext() ? folders.next() : parent.createFolder(subFolderName);
}
